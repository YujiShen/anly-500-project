---
title: "ANLY 500 Final Project"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(reshape2)
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(stringr)
library(knitr)
library(MOTE)
library(pwr)
```

# Read Data
```{r}
data = read_csv('data_cleaned.csv', col_types = paste0('cfflfff', strrep('i', 22), strrep('d', 8)))
data$Tier = factor(data$Tier, levels = c("Selective private", "Selective public", "Highly selective private", "Highly selective public", "Other elite schools (public and private)", "Ivy Plus"))
```

# Algorithm and Models
```{r eval=FALSE, echo=FALSE}
##Read the 4th dataset
salary_degree <-
  read_csv(
    'degrees-that-pay-back.csv',
    col_names = c(
      "major",
      "start_med_slry",
      "mid_car_slry",
      "percent_chng",
      "mid_car_10th",
      "mid_car_25th",
      "mid_car_75th",
      "mid_car_90th"
    ),
    col_types = "cnndnnnn", # specify column types to coerce '$' to numeric
    skip = 1 # names specified, skip header
  ) 

#####
cleanup<-theme(panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(),
               panel.background = element_blank(),
               axis.line.x = element_line(color = 'black'),
               axis.line.y = element_line(color = 'black'),
               legend.key = element_rect(fill = 'white'),
               text = element_text(size = 12)) 
##  Plot degree v/s starting salary
p1 <- ggplot(salary_degree, aes(x = reorder(major, start_med_slry), start_med_slry)) +
  geom_col(fill = "blue", alpha = 0.5) +
  geom_col(aes(x = reorder(major, mid_car_slry), mid_car_slry), alpha = 0.3) +
  geom_text(aes(label = (start_med_slry)), size = 3, hjust = 1.1, col="yellow")+
   xlab(NULL) +
  ylab("Salary in $")+
  coord_flip() +
  ggtitle("Starting salary v/s mid career salary in $")+
  cleanup
p1

## Top 10 school 

accent_colors_edit <- brewer.pal(n = 5, "Pastel1")[c(1:3, 5)]  # keep colors consistent for plot w/o 'party'

top10_colleges <- data %>%
  select(School.Name, School.Type, MD_EARN_WNE_P8) %>%
  arrange(desc(MD_EARN_WNE_P8)) %>%
  top_n(10)
top10_colleges
ggplot(top10_colleges, aes(reorder(School.Name, MD_EARN_WNE_P8), MD_EARN_WNE_P8, fill = School.Type)) +
  geom_col(alpha = 0.8) +
  scale_fill_manual(values = accent_colors_edit) +
  geom_text(aes(label =(MD_EARN_WNE_P8)), hjust = 1.1, color = 'gray30') +
   xlab(NULL) +
  ggtitle("Top 10 colleges")+
  ylab("Mid career salary in $")+
   coord_flip()
## Any correlation b/w starting salary and mid career salary

ggplot(data, aes(MD_EARN_WNE_P6, MD_EARN_WNE_P8)) +
  geom_point(alpha = 0.6) +
  geom_smooth(se = F) +
  xlab("Starting salary in $")+
  ylab("Mid career salary in $")
 
 
## Count by college type

ggplot(data, aes(School.Type)) +
  geom_bar(color = 'black', alpha = 0.8)
  
##  Region and type
  ggplot(data, aes(Region, fill = School.Type)) +
    geom_bar(position = 'dodge', alpha = 0.8, color = 'gray20') +
    scale_fill_brewer(palette = 'Pastel1') +
    theme(legend.position = "top")  

# How do starting salary and mid-career median salary differ over region and type? 

#Below is a look at the mean starting and mid-career salaries over these two categories.
  ggplot(data, aes(reorder(Region, MN_EARN_WNE_P6), MD_EARN_WNE_P8, fill = School.Type)) +
    stat_summary(geom = 'col', position = 'dodge', alpha = 0.6) +
    stat_summary(aes(Region, MN_EARN_WNE_P6, fill = School.Type),
                 geom = 'col', position = 'dodge') +
    scale_fill_brewer(palette = 'Pastel1') +
      xlab('Region') +
    ylab('Salaries in $') +
    ggtitle('Mean starting and Mid-career median salaries') +
    coord_flip()
```

# Gender & Family
```{r data-wrangle}
data_gender_p6 = data %>%
  melt(id.vars=1:8, measure.vars=c( "MN_EARN_WNE_MALE0_P6", "MN_EARN_WNE_MALE1_P6"), variable.name="Gender", value.name="Income") %>%
  mutate(
    Gender = factor(Gender, levels = c("MN_EARN_WNE_MALE0_P6", "MN_EARN_WNE_MALE1_P6"), labels = c("Female", "Male")),
    ROI = (Income-COSTT4_A)/COSTT4_A*100
  )
  
data_gender_p10 = data %>%
  melt(id.vars=1:8, measure.vars=c( "MN_EARN_WNE_MALE0_P10", "MN_EARN_WNE_MALE1_P10"), variable.name="Gender", value.name="Income") %>%
  mutate(
    Gender = factor(Gender, levels = c("MN_EARN_WNE_MALE0_P10", "MN_EARN_WNE_MALE1_P10"), labels = c("Female", "Male")),
    ROI = (Income-COSTT4_A)/COSTT4_A*100
  )

data_family_p6 = data %>%
  melt(id.vars=1:8, measure.vars=c( "MN_EARN_WNE_INC1_P6", "MN_EARN_WNE_INC2_P6", "MN_EARN_WNE_INC3_P6"), variable.name="Family.Income", value.name="Income") %>%
  mutate(
    Family.Income = factor(Family.Income, levels = c("MN_EARN_WNE_INC1_P6", "MN_EARN_WNE_INC2_P6", "MN_EARN_WNE_INC3_P6"), labels = c("Low", "Middle", "High")),
    ROI = (Income-COSTT4_A)/COSTT4_A*100
  )

data_family_p10 = data %>%
  melt(id.vars=1:8, measure.vars=c( "MN_EARN_WNE_INC1_P10", "MN_EARN_WNE_INC2_P10", "MN_EARN_WNE_INC3_P10"), variable.name="Family.Income", value.name="Income") %>%
  mutate(
    Family.Income = factor(Family.Income, levels = c("MN_EARN_WNE_INC1_P10", "MN_EARN_WNE_INC2_P10", "MN_EARN_WNE_INC3_P10"), labels = c("Low", "Middle", "High")),
    ROI = (Income-COSTT4_A)/COSTT4_A*100
  )
```

```{r plot-family, dpi=300, fig.width=8, fig.height=6, fig.path="figures/"}
#Explore the interaction effect with what you can't change - family and gender
plot_elements = function() {
  list(
    theme_classic(),
    stat_summary(fun.y = mean,
               geom = "bar",
               position = "dodge"),
    stat_summary(fun.data = mean_cl_normal,
               geom = "errorbar",
               position = position_dodge(width = 0.9),
               width = 0.1)
  )
}

data_family_p6 %>%
  drop_na() %>%
  ggplot(aes(Is.Party, Income, fill=Family.Income)) +
  xlab("Party School?")+
  ylab("Starting Salary") +
  ggtitle("Mid-career Salary group by Party School and Famly Income Level") +
  scale_fill_manual(name = "Family Income Level",
                    labels = c("Low ($30k-)", "Medium ($30k~$75k)", "High ($75k+)"),
                    values = c("Pink", "Lavender", "LightBlue")) +
  plot_elements()

data_family_p10 %>%
  drop_na() %>%
  ggplot(aes(Is.Party, Income, fill=Family.Income)) +
  xlab("Party School?")+
  ylab("Mid-career Salary") +
  ggtitle("Mid-career Salary group by Party School and Famly Income Level") +
  scale_fill_manual(name = "Family Income Level",
                    labels = c("Low ($30k-)", "Medium ($30k~$75k)", "High ($75k+)"),
                    values = c("Pink", "Lavender", "LightBlue")) +
  plot_elements()


data_family_p6 %>%
  drop_na() %>%
  ggplot(aes(School.Type, Income, fill=Family.Income)) +
  xlab("School Type")+
  ylab("Starting Salary") +
  ggtitle("Starting Salary group by School Type and Famly Income Level") +
  scale_fill_manual(name = "Family Income Level",
                    labels = c("Low ($30k-)", "Medium ($30k~$75k)", "High ($75k+)"),
                    values = c("Pink", "Lavender", "LightBlue")) +
  plot_elements()

data_family_p10 %>%
  drop_na() %>%
  ggplot(aes(School.Type, Income, fill=Family.Income)) +
  xlab("School Type")+
  ylab("Mid-career Salary") +
  ggtitle("Mid-career Salary group by School Type and Famly Income Level") +
  scale_fill_manual(name = "Family Income Level",
                    labels = c("Low ($30k-)", "Medium ($30k~$75k)", "High ($75k+)"),
                    values = c("Pink", "Lavender", "LightBlue")) +
  plot_elements()
```

```{r plot-gender, dpi=300, fig.width=8, fig.height=6, fig.path="figures/"}
data_gender_p6 %>%
  drop_na() %>%
  ggplot(aes(School.Type, Income, fill=Gender)) +
  xlab("School Type")+
  ylab("Starting Salary") +
  ggtitle("Starting Salary group by School Type and Gender") +
  plot_elements()

data_gender_p6 %>%
  drop_na() %>%
  ggplot(aes(School.Type, Income, fill=Gender)) +
  xlab("School Type")+
  ylab("Mid-career Salary") +
  ggtitle("Mid-career Salary group by School Type and Gender") +
  plot_elements()

data_gender_p6 %>%
  drop_na() %>%
  ggplot(aes(Tier, Income, fill=Gender)) +
  xlab("School Tier")+
  ylab("Starting Salary") +
  ggtitle("Starting Salary group by School Tier and Gender") +
  plot_elements() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

data_gender_p6 %>%
  drop_na() %>%
  ggplot(aes(Tier, Income, fill=Gender)) +
  xlab("School Tier")+
  ylab("Mid-career Salary") +
  ggtitle("Mid-career Salary group by School Tier and Gender") +
  plot_elements() + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

```



```{r t-test}
#T-test to see if there is a difference in starting income from the two different gender group
#H0: Male = Female
#H1: Male <> Female
data_gender_p6 = drop_na(data_gender_p6)
t.test(data_gender_p6$Income ~ data_gender_p6$Gender)

M = tapply(data_gender_p6$Income, data_gender_p6$Gender, mean) 
N = tapply(data_gender_p6$Income, data_gender_p6$Gender, length) 
stdev = tapply(data_gender_p6$Income, data_gender_p6$Gender, sd) 
M;stdev;N

effect1 = d.ind.t(
  m1 = M[1], m2 = M[2],
  sd1 = stdev[1], sd2 = stdev[2], 
  n1 = N[1], n2 = N[2], a = .05) 
effect1$d

pwr.t.test(n = NULL, d = effect1$d, 
           sig.level = .05,
           power = .80, type = "two.sample", 
           alternative = "two.sided")


#T-test to see if there is a difference in mid-career income from the two different gender group
#H0: Male = Female
#H1: Male <> Female
data_gender_p10 = drop_na(data_gender_p10)
t.test(data_gender_p10$Income ~ data_gender_p10$Gender)

M = tapply(data_gender_p10$Income, data_gender_p10$Gender, mean) 
N = tapply(data_gender_p10$Income, data_gender_p10$Gender, length) 
stdev = tapply(data_gender_p10$Income, data_gender_p10$Gender, sd) 
M;stdev;N

effect2 = d.ind.t(
  m1 = M[1], m2 = M[2],
  sd1 = stdev[1], sd2 = stdev[2], 
  n1 = N[1], n2 = N[2], a = .05) 
effect2$d

pwr.t.test(n = NULL, d = effect2$d, 
           sig.level = .05,
           power = .80, type = "two.sample", 
           alternative = "two.sided")
```

```{r regression, dpi=300, fig.width=8, fig.height=6, fig.path="figures/"}
model_gender_p6_1 = lm(ROI ~ Gender, data = data_gender_p6)
summary(model_gender_p6_1)

model_gender_p6_2 = lm(ROI ~ Gender + CONTROL, data = data_gender_p6)
summary(model_gender_p6_2)
anova(model_gender_p6_1, model_gender_p6_2)

model_gender_p6_3 = lm(ROI ~ Gender + CONTROL + School.Type, data = data_gender_p6)
summary(model_gender_p6_3)
anova(model_gender_p6_2, model_gender_p6_3)

model_gender_p6_4 = lm(ROI ~ Gender + CONTROL + School.Type + STABBR, data = data_gender_p6)
summary(model_gender_p6_4)
anova(model_gender_p6_3, model_gender_p6_4)

## Is.Party is not helpful
model_gender_p6_5 = lm(ROI ~ Gender + CONTROL + School.Type + STABBR + Is.Party, data = data_gender_p6)
summary(model_gender_p6_5)
anova(model_gender_p6_4, model_gender_p6_5)

## Tier is not helpful
model_gender_p6_6 = lm(ROI ~ Gender + CONTROL + School.Type + STABBR + Tier, data = data_gender_p6)
summary(model_gender_p6_6)
anova(model_gender_p6_4, model_gender_p6_6)

# Region is not helpful
model_gender_p6_7 = lm(ROI ~ Gender + CONTROL + School.Type + STABBR + Region, data = data_gender_p6)
summary(model_gender_p6_7)
anova(model_gender_p6_5, model_gender_p6_7)

# Final model: ROI ~ Gender + CONTROL + School.Type + STABBR
```

By using hierarchical regression, we find the best model to predict starting salary based on gender is ROI ~ Gender + CONTROL + School.Type + STABBR. Tier, Is.Party and Region will not help to improve the model. 

The model meets the assumptions of linear regression:

```{r lm-assumption}
plot(model_gender_p6_4)
```

Here is the table for coefficients:

```{r}
kable(coefficients(summary(model_gender_p6_4)))
```

Overall, this model can explain about 80% of the variance (Adjusted R-squared=0.80) and very significant (p=.00).

To be specific:

  - Gender: Compared to female students, male students will significantly(p=.00) improve their ROI about 28.51%.
  - Tier: Tier (Selectivity) information is partially correlated with CONTROL because some of them are dedicated public or private category. It also correlate with School.Type, for example Ivy League category. And the ANOVA test of model shows that it will not help to improve model when both CONTROL and School.Type are present.
  - Control: Whether a school is public or private weight most in the model. If a student go to a public school, his/her ROI will go up about 79.27% compared to a student go to a private school. This probably caused by the lower cost of public schools.
  - School.Type: Compared to students go to engineering school, students who go to Liberal Arts school will have much lower ROI by 43.02%. This probably caused by the low starting salary for those students.
  - STABBR: Compared to students in California, students in Wyoming, Louisiana and Utah will get higher ROI, but students in Illinois, Tennessee will get lower ROI.

We can't do mediation test since all independent variables are not numerical. We can't compute 'a' path model.
